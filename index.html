<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Calculadora de Costos de Recetas</title>
<style>
:root{
  --bg:#0f172a; --card:#111827; --muted:#9ca3af; --pri:#22c55e; --sec:#38bdf8;
}
*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto}
body{margin:0;background:linear-gradient(120deg,#020617,#0f172a);color:#e5e7eb}
header{padding:16px 20px;display:flex;gap:12px;align-items:center}
header h1{font-size:20px;margin:0}
main{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
.card{background:rgba(17,24,39,.9);border:1px solid #1f2933;border-radius:14px;padding:14px}
.btn{background:#1f2937;border:1px solid #374151;color:#e5e7eb;padding:8px 10px;border-radius:10px;cursor:pointer}
.btn.pri{background:linear-gradient(90deg,#22c55e,#38bdf8);color:#052e16;border:none}
.btn.ghost{background:transparent}
.row{display:flex;gap:8px;align-items:center}
.col{display:flex;flex-direction:column;gap:8px}
.list{display:flex;flex-direction:column;gap:6px}
.item{padding:8px;border-radius:10px;border:1px solid #1f2937;cursor:pointer}
.item.active{outline:2px solid var(--sec)}
input,select{background:#020617;border:1px solid #1f2937;color:#e5e7eb;padding:6px 8px;border-radius:8px}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #1f2937;padding:6px;text-align:left;font-size:13px}
tfoot td{font-weight:700}
.kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.k{background:#020617;border:1px solid #1f2937;border-radius:12px;padding:10px}
.k b{font-size:18px}
small{color:var(--muted)}
@media(max-width:900px){main{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <h1>ðŸ§® Costos de Recetas</h1>
  <button class="btn pri" onclick="newRecipe()">+ Nueva receta</button>
  <button class="btn ghost" onclick="exportCSV()">Exportar CSV</button>
</header>

<main>
  <aside class="card">
    <h3>Recetas</h3>
    <div id="recipes" class="list"></div>
  </aside>

  <section class="card">
    <div class="row">
      <input id="rName" placeholder="Nombre de la receta" style="flex:1"/>
      <input id="rYield" type="number" min="1" placeholder="Rendimiento" style="width:140px"/>
      <button class="btn" onclick="duplicate()">Duplicar</button>
      <button class="btn" onclick="remove()">Eliminar</button>
    </div>

    <div class="kpi" style="margin:10px 0">
      <div class="k"><small>Costo total</small><b id="kTotal">$0.00</b></div>
      <div class="k"><small>Costo por porciÃ³n</small><b id="kUnit">$0.00</b></div>
      <div class="k"><small>Food Cost</small><b id="kFc">â€”</b></div>
      <div class="k"><small>Precio sugerido</small><b id="kSell">$0.00</b></div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Ingrediente</th><th>Unidad</th><th>Precio unidad (USD)</th>
          <th>Cantidad usada</th><th>Costo</th><th></th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
      <tfoot>
        <tr>
          <td colspan="6">
            <button class="btn pri" onclick="addRow()">+ Agregar ingrediente</button>
          </td>
        </tr>
      </tfoot>
    </table>
  </section>
</main>

<script>
const MARGIN = 0.70;
let data = JSON.parse(localStorage.getItem("rc_data")||"[]");
let idx = 0;

function save(){ localStorage.setItem("rc_data", JSON.stringify(data)); render(); }
function money(n){ return "$"+(n||0).toFixed(2); }

function newRecipe(){
  data.push({name:"Nueva receta", yield:1, items:[]});
  idx = data.length-1; save();
}
function duplicate(){
  if(!data[idx])return;
  const c = JSON.parse(JSON.stringify(data[idx]));
  c.name += " (copia)";
  data.push(c); idx = data.length-1; save();
}
function remove(){
  if(!data[idx])return;
  if(confirm("Â¿Eliminar receta?")){ data.splice(idx,1); idx=Math.max(0,idx-1); save(); }
}

function addRow(){
  data[idx].items.push({n:"",u:"g",p:0,q:0});
  save();
}

function render(){
  const list = document.getElementById("recipes");
  list.innerHTML = "";
  data.forEach((r,i)=>{
    const d=document.createElement("div");
    d.className="item"+(i===idx?" active":"");
    d.textContent=r.name;
    d.onclick=()=>{idx=i; render();}
    list.appendChild(d);
  });

  const r=data[idx];
  if(!r){ return; }
  rName.value=r.name; rYield.value=r.yield;

  const rows=document.getElementById("rows");
  rows.innerHTML="";
  let total=0;
  r.items.forEach((it,i)=>{
    const cost = (it.p||0)*(it.q||0);
    total+=cost;
    rows.insertAdjacentHTML("beforeend",`
      <tr>
        <td><input value="${it.n}" oninput="edit(${i},'n',this.value)"></td>
        <td><select onchange="edit(${i},'u',this.value)">
          ${["g","kg","ml","L","unidad"].map(u=>`<option ${u===it.u?"selected":""}>${u}</option>`).join("")}
        </select></td>
        <td><input type="number" step="0.01" value="${it.p}" oninput="edit(${i},'p',+this.value)"></td>
        <td><input type="number" step="0.01" value="${it.q}" oninput="edit(${i},'q',+this.value)"></td>
        <td>${money(cost)}</td>
        <td><button class="btn" onclick="delRow(${i})">âœ•</button></td>
      </tr>
    `);
  });

  const per = total/(r.yield||1);
  const sell = per/(1-MARGIN);
  kTotal.textContent = money(total);
  kUnit.textContent = money(per);
  kSell.textContent = money(sell);
  kFc.textContent = r.yield? Math.round((per/sell)*100)+"%":"â€”";
}

function edit(i,k,v){ data[idx].items[i][k]=v; save(); }
function delRow(i){ data[idx].items.splice(i,1); save(); }

rName.oninput=()=>{ data[idx].name=rName.value; save(); }
rYield.oninput=()=>{ data[idx].yield=+rYield.value||1; save(); }

function exportCSV(){
  let out="Receta,Ingrediente,Unidad,PrecioUnidad,Cantidad,Costo\n";
  data.forEach(r=>{
    r.items.forEach(it=>{
      const c=(it.p||0)*(it.q||0);
      out+=`${r.name},${it.n},${it.u},${it.p},${it.q},${c}\n`;
    });
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([out],{type:"text/csv"}));
  a.download="costos_recetas.csv"; a.click();
}

if(!data.length) newRecipe(); else render();
</script>
</body>
</html>
